name: Stack Verification

on:
  push:
    paths:
      - 'docker-compose.yml'
      - 'scripts/verify_compose_stack.py'
      - '.github/workflows/stack-verification.yml'
  pull_request:
    paths:
      - 'docker-compose.yml'
      - 'scripts/verify_compose_stack.py'
  schedule:
    - cron: '0 */6 * * *'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install prometheus-client pyyaml
      - name: Run compose stack verification
        run: |
          python scripts/verify_compose_stack.py > verify_output.json || true
          cat verify_output.json
      - name: Fail on structural/network errors
        run: |
          python - <<'PY'
import json,sys
data=json.load(open('verify_output.json'))
if data.get('status')!='ok':
    print('STACK VERIFICATION FAILED:',data)
    sys.exit(1)
print('Stack verification succeeded.')
PY
