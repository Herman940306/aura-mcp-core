name: Deploy to Staging

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - preview
      skip_tests:
        description: 'Skip pre-deployment tests'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-deploy-tests:
    name: Pre-Deployment Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov httpx
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Run smoke tests
      run: |
        pytest tests/test_unit_comprehensive.py -v \
          -m "not slow" \
          --tb=short \
          -x


  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [ pre-deploy-tests ]
    if: always() && (needs.pre-deploy-tests.result == 'success' || needs.pre-deploy-tests.result == 'skipped')
    
    outputs:
      gateway_tag: ${{ steps.meta-gateway.outputs.tags }}
      backend_tag: ${{ steps.meta-backend.outputs.tags }}
      dashboard_tag: ${{ steps.meta-dashboard.outputs.tags }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata (Gateway)
      id: meta-gateway
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/gateway
        tags: |
          type=sha,prefix=staging-
          type=raw,value=staging
          
    - name: Build and push Gateway
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile.mcp
        push: true
        tags: ${{ steps.meta-gateway.outputs.tags }}
        labels: ${{ steps.meta-gateway.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Extract metadata (Backend)
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/ml-backend
        tags: |
          type=sha,prefix=staging-
          type=raw,value=staging
          
    - name: Build and push Backend
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile.backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Extract metadata (Dashboard)
      id: meta-dashboard
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/dashboard
        tags: |
          type=sha,prefix=staging-
          type=raw,value=staging
          
    - name: Build and push Dashboard
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile.dashboard
        push: true
        tags: ${{ steps.meta-dashboard.outputs.tags }}
        labels: ${{ steps.meta-dashboard.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max


  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ build-images ]
    environment:
      name: staging
      url: https://staging.aura-ia.example.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
        
    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.STAGING_KUBECONFIG }}" | base64 -d > ~/.kube/config
        
    - name: Update Kubernetes manifests
      run: |
        cd k8s
        
        # Update image tags in deployment
        sed -i "s|image:.*gateway.*|image: ghcr.io/${{ github.repository }}/gateway:staging|g" deployment.yaml
        sed -i "s|image:.*ml-backend.*|image: ghcr.io/${{ github.repository }}/ml-backend:staging|g" deployment.yaml
        sed -i "s|image:.*dashboard.*|image: ghcr.io/${{ github.repository }}/dashboard:staging|g" deployment.yaml
        
    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secrets.yaml || true
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/aura-gateway --timeout=300s
        kubectl rollout status deployment/aura-ml-backend --timeout=300s
        kubectl rollout status deployment/aura-dashboard --timeout=300s
        
    - name: Run post-deployment health check
      run: |
        echo "Waiting for services to stabilize..."
        sleep 30
        
        # Health check endpoints
        curl -f https://staging.aura-ia.example.com/healthz || exit 1
        curl -f https://staging.aura-ia.example.com/api/readyz || exit 1
        
        echo "✅ Deployment successful!"


  integration-verification:
    name: Post-Deploy Integration Tests
    runs-on: ubuntu-latest
    needs: [ deploy-staging ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest httpx
        
    - name: Run integration tests against staging
      run: |
        pytest tests/test_integration_enterprise.py -v \
          --tb=short \
          -m "smoke"
      env:
        GATEWAY_URL: https://staging.aura-ia.example.com
        
    - name: Run governance compliance check
      run: |
        pytest tests/test_governance_compliance.py -v \
          --tb=short \
          -k "test_prd or test_hnsc"
      env:
        GATEWAY_URL: https://staging.aura-ia.example.com


  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [ integration-verification ]
    if: failure()
    
    steps:
    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.STAGING_KUBECONFIG }}" | base64 -d > ~/.kube/config
        
    - name: Rollback deployments
      run: |
        echo "⚠️ Integration tests failed, rolling back..."
        kubectl rollout undo deployment/aura-gateway
        kubectl rollout undo deployment/aura-ml-backend
        kubectl rollout undo deployment/aura-dashboard
        
    - name: Notify on rollback
      uses: slackapi/slack-github-action@v1
      if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
      with:
        payload: |
          {
            "text": "⚠️ Staging deployment failed and was rolled back",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "⚠️ *Staging Deployment Failed*\n\nWorkflow: ${{ github.workflow }}\nRun: ${{ github.run_number }}\nCommit: ${{ github.sha }}\n\nThe deployment was automatically rolled back."
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
