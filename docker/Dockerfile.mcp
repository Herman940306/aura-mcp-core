# ═══════════════════════════════════════════════════════════════════════════════
# AURA IA MCP - Gateway Service (CPU-only)
# ═══════════════════════════════════════════════════════════════════════════════
# MCP SSE Gateway - routes requests to ML backend
# Lightweight, does not require GPU
# ═══════════════════════════════════════════════════════════════════════════════

FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    AURA_DEVICE=cpu

WORKDIR /app

# ─────────────────────────────────────────────────────────────────────────────
# Install system dependencies
# ─────────────────────────────────────────────────────────────────────────────
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    curl netcat-traditional ca-certificates \
    libsndfile1 espeak-ng ffmpeg \
    build-essential gcc g++ cmake \
    && rm -rf /var/lib/apt/lists/*

# ─────────────────────────────────────────────────────────────────────────────
# Install Python dependencies
# ─────────────────────────────────────────────────────────────────────────────
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Install base requirements
COPY requirements-base.txt ./
RUN pip install --no-cache-dir -r requirements-base.txt

# Install gateway-specific requirements (currently empty)
COPY requirements-gateway.txt ./
RUN pip install --no-cache-dir -r requirements-gateway.txt

# ─────────────────────────────────────────────────────────────────────────────
# Copy application code
# ─────────────────────────────────────────────────────────────────────────────
COPY src ./src
COPY aura_ia_mcp ./aura_ia_mcp
COPY config ./config
COPY data ./data

ENV PYTHONPATH=/app/src:/app \
    IDE_AGENTS_BACKEND_URL=http://aura-ia-ml:8001 \
    MCP_HOST=0.0.0.0 \
    MCP_PORT=8000 \
    MCP_TRANSPORT=sse

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=5s --start-period=20s --retries=5 \
    CMD nc -z 127.0.0.1 8000 || exit 1

CMD ["python", "-m", "mcp_server.ide_agents_mcp_server"]
